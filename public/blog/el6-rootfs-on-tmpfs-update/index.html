<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> CentOS/RHEL/SL 6: root filesystem on tmpfs, UPDATE &middot; golb </title>

  
  <link rel="stylesheet" href="http://localhost:1313/css/poole.css">
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:1313/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="golb" />
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>golb</h1>
      <p class="lead">
        Espen Braastad
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
    </ul>
  </div>
</div>


    <div class="content container">
<div class="post">
  <h1>CentOS/RHEL/SL 6: root filesystem on tmpfs, UPDATE</h1>
  <span class="post-date">Thu, Mar 21, 2013</span>
      <p>In EL6.4, the file /usr/share/dracut/modules.d/90dmsquash-live/dmsquash-live-root was updated so that the previous patch no longer works as it should. Iâ€™ve updated the patch, and here it is:</p>

<pre><code>--- original    2013-03-20 16:25:23.698846581 +0100
+++ new 2013-03-21 08:58:11.175339694 +0100
@@ -24,6 +24,8 @@
 getarg readonly_overlay &amp;&amp; readonly_overlay=&quot;--readonly&quot; || readonly_overlay=&quot;&quot;
 overlay=$(getarg overlay)

+getarg toram &amp;&amp; toram=&quot;yes&quot;
+
 # FIXME: we need to be able to hide the plymouth splash for the check really
 [ -e $livedev ] &amp; fs=$(blkid -s TYPE -o value $livedev)
 if [ &quot;$fs&quot; = &quot;iso9660&quot; -o &quot;$fs&quot; = &quot;udf&quot; ]; then
@@ -132,7 +134,10 @@
     BASE_LOOPDEV=$( losetup -f )
     losetup -r $BASE_LOOPDEV $EXT3FS

-    do_live_from_base_loop
+    # Create overlay only if toram is not set
+    if [ -z &quot;$toram&quot; ] ; then
+        do_live_from_base_loop
+    fi
 fi

 # we might have an embedded ext3 on squashfs to use as rootfs (compressed live)
@@ -163,13 +168,66 @@

     umount -l /squashfs

-    do_live_from_base_loop
+    # Create overlay only if toram is not set
+    if [ -z &quot;$toram&quot; ] ; then
+        do_live_from_base_loop
+    fi
+fi
+
+# If the kernel parameter toram is set, create a tmpfs device and copy the 
+# filesystem to it. Continue the boot process with this tmpfs device as
+# a writable root device.
+if [ -n &quot;$toram&quot; ] ; then
+    blocks=$( blockdev --getsz $BASE_LOOPDEV )
+
+    echo &quot;Create tmpfs ($blocks blocks) for the root filesystem...&quot;
+    mkdir -p /image
+    mount -n -t tmpfs -o nr_blocks=$blocks tmpfs /image
+
+    echo &quot;Copy filesystem image to tmpfs... (this may take a few minutes)&quot;
+    dd if=$BASE_LOOPDEV of=/image/rootfs.img
+
+    ROOTFS_LOOPDEV=$( losetup -f )
+    echo &quot;Create loop device for the root filesystem: $ROOTFS_LOOPDEV&quot;
+    losetup $ROOTFS_LOOPDEV /image/rootfs.img
+
+    echo &quot;It's time to clean up.. &quot;
+
+    echo &quot; &gt; Umounting images&quot;
+    umount -l /image
+    umount -l /dev/.initramfs/live
+
+    echo &quot; &gt; Detach $OSMIN_LOOPDEV&quot;
+    losetup -d $OSMIN_LOOPDEV
+
+    echo &quot; &gt; Detach $OSMIN_SQUASHED_LOOPDEV&quot;
+    losetup -d $OSMIN_SQUASHED_LOOPDEV
+    
+    echo &quot; &gt; Detach $BASE_LOOPDEV&quot;
+    losetup -d $BASE_LOOPDEV
+    
+    echo &quot; &gt; Detach $SQUASHED_LOOPDEV&quot;
+    losetup -d $SQUASHED_LOOPDEV
+    
+    echo &quot; &gt; Detach /dev/loop0&quot;
+    losetup -d /dev/loop0
+
+    losetup -a
+
+    echo &quot;Root filesystem is now on $ROOTFS_LOOPDEV.&quot;
+    echo
+
+    ln -s $ROOTFS_LOOPDEV /dev/root
+    printf '/bin/mount -o rw %s %s\n' &quot;$ROOTFS_LOOPDEV&quot; &quot;$NEWROOT&quot; &gt; /mount/01-$$-live.sh
+    exit 0
 fi

 if [ -b &quot;$OSMIN_LOOPDEV&quot; ]; then
     # set up the devicemapper snapshot device, which will merge
     # the normal live fs image, and the delta, into a minimzied fs image
-    echo &quot;0 $( blockdev --getsz $BASE_LOOPDEV ) snapshot $BASE_LOOPDEV $OSMIN_LOOPDEV p 8&quot; | dmsetup create --readonly live-osimg-min
+    if [ -z &quot;$toram&quot; ] ; then
+        echo &quot;0 $( blockdev --getsz $BASE_LOOPDEV ) snapshot $BASE_LOOPDEV $OSMIN_LOOPDEV p 8&quot; | dmsetup create --readonly live-osimg-min
+    fi
 fi

 ROOTFLAGS=&quot;$(getarg rootflags)&quot;
</code></pre>

<p>It may be easier to download it from here.</p>

</div>
</div>

  <script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>
